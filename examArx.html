<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crasher Online Sınaq Sistemi</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f9; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        #timer { position: sticky; top: 10px; background: #e74c3c; color: white; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; z-index: 100; }
        .question-block { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; transition: 0.3s; }
        .option { display: block; margin: 8px 0; cursor: pointer; padding: 8px; border-radius: 4px; border: 1px solid #eee; }
        .option:hover { background: #f9f9f9; }
        button { display: block; width: 100%; padding: 15px; font-size: 18px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #27ae60; }
        #result { margin-top: 20px; }
        .correct-ans { background-color: #d4edda !important; }
        .wrong-ans { background-color: #f8d7da !important; }
        .skipped-ans { background-color: #fff3cd !important; }
    </style>
</head>
<body>

<div class="container">
    <h2>Online Sınaq İmtahanı</h2>
    <div id="timer">Yüklənir...</div>
    <div id="quiz">Suallar hazırlanır...</div>
    <button id="finishBtn" onclick="finish()" style="display:none;">İmtahanı Bitir</button>
    <div id="result"></div>
</div>

<script>
const TIME_LIMIT = 30 * 60; // 30 dəqiqə
let TIME = TIME_LIMIT;
let interval;
let startScore = 0;
let currentQuestions = [];
const QUESTIONS_URL = "questions.json"; // Fayl eyni qovluqda olmalıdır

function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}

async function loadQuestions() {
    const quizDiv = document.getElementById("quiz");
    quizDiv.innerHTML = "Suallar yüklənir...";

    try {
        console.log("Fetch başlayır: " + QUESTIONS_URL);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 saniyə timeout

        const res = await fetch(QUESTIONS_URL, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!res.ok) {
            throw new Error(`Server xətası: ${res.status} - ${res.statusText}`);
        }

        const allQuestions = await res.json();
        console.log("JSON yükləndi, sual sayı:", allQuestions.length);

        const validQuestions = allQuestions.filter(q => q.q && q.options && q.correct);
        if (validQuestions.length === 0) throw new Error("Heç bir düzgün sual tapılmadı");

        currentQuestions = shuffle([...validQuestions]).slice(0, 25); // 25 random sual

        quizDiv.innerHTML = "";
        currentQuestions.forEach((q, i) => {
            let optionsHtml = "";
            Object.keys(q.options).forEach(key => {
                optionsHtml += `
                    <label class="option">
                        <input type="radio" name="q${i}" value="${key}"> ${key}) ${q.options[key]}
                    </label>`;
            });

            optionsHtml += `
                <label class="option" style="background: #f1f2f6; border-style: dashed;">
                    <input type="radio" name="q${i}" value="BOS"> <b>Boş burax (bal silinmir)</b>
                </label>`;

            quizDiv.innerHTML += `
                <div id="block${i}" class="question-block">
                    <p><b>${i + 1}. ${q.q}</b></p>
                    ${optionsHtml}
                    <div id="feedback${i}" style="margin-top:10px;"></div>
                </div>`;
        });

        document.getElementById("finishBtn").style.display = "block";
        startTimer();
    } catch (err) {
        console.error("Xəta:", err.message);
        quizDiv.innerHTML = `
            <div style="color:red; text-align:center; padding:20px;">
                <h3>Xəta baş verdi!</h3>
                <p>${err.message}</p>
                <p>Console-da (F12) detallara baxın. Çox güman ki, questions.json faylı yüklənmədi və ya cache problemidir.</p>
                <button onclick="location.reload()">Yenidən cəhd et</button>
            </div>`;
    }
}

function start() {
    const val = prompt("İmtahana giriş balın neçədir? (0–50, boş buraxa bilərsən)", "0");
    startScore = parseInt(val) || 0;
    if (startScore < 0 || startScore > 50) startScore = 0;

    loadQuestions(); // fetch-i buradan çağırırıq
}

function startTimer() {
    document.getElementById("timer").innerText = `Qalan vaxt: 30:00`;
    interval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    if (TIME <= 0) { finish(); return; }
    TIME--;
    const m = Math.floor(TIME / 60);
    const s = TIME % 60;
    document.getElementById("timer").innerText = `Qalan vaxt: ${m}:${s < 10 ? '0' + s : s}`;
}

function finish() {
    clearInterval(interval);
    window.scrollTo(0, 0);
    document.getElementById("finishBtn").style.display = "none";

    let correctCount = 0;
    let wrongCount = 0;

    currentQuestions.forEach((q, i) => {
        const selected = document.querySelector(`input[name="q${i}"]:checked`);
        const block = document.getElementById(`block${i}`);
        const feedback = document.getElementById(`feedback${i}`);

        if (selected) {
            if (selected.value === q.correct) {
                correctCount++;
                block.classList.add("correct-ans");
                feedback.innerHTML = "<b>✅ Doğru (+2 bal)</b>";
            } else if (selected.value === "BOS") {
                block.classList.add("skipped-ans");
                feedback.innerHTML = `<b>⚪ Boş buraxıldı.</b> Düzgün: ${q.correct}`;
            } else {
                wrongCount++;
                block.classList.add("wrong-ans");
                feedback.innerHTML = `<b>❌ Səhv! (-1 bal)</b> Düzgün: ${q.correct}`;
            }
        } else {
            block.classList.add("skipped-ans");
            feedback.innerHTML = `<b>⚪ Cavabsız.</b> Düzgün: ${q.correct}`;
        }
    });

    const examScore = (correctCount * 2) - (wrongCount * 1);
    const total = startScore + examScore;

    document.getElementById("result").innerHTML = `
        <div style="background:#2c3e50; color:white; padding:20px; border-radius:10px; text-align:center;">
            <h2>Nəticə</h2>
            <p>Doğru: ${correctCount} | Səhv: ${wrongCount}</p>
            <p>Sınaq Balı: ${examScore} (doğru ×2 - səhv ×1)</p>
            <hr>
            <h3>Yekun Bal: ${total}</h3>
        </div>`;
}

// Səhifə yüklənəndə dərhal başla
window.onload = start;
</script>
</body>
</html>
